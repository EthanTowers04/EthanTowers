<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ethan Towers — CV</title>

<!-- Prefer CORS-enabled script loading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js" crossorigin="anonymous"></script>

<style>
    body {
        font-family: sans-serif;
        background: #f7f7f7;
        margin: 0;
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 30px;
    }
    #pdf-viewer {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 20px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }
    canvas {
        display: block;
        margin: 30px auto;
        border: 1px solid #ddd;
        width: 100%;
        height: auto;
    }
    #download-link {
        text-align: center;
        margin-top: 30px;
    }
    #download-link a {
        display: inline-block;
        padding: 12px 20px;
        background: #0070f3;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-size: 16px;
    }
    #download-link a:hover {
        background: #0059c9;
    }

    #loading {
        text-align: center;
        color: #333;
    }

    #error {
        text-align: center;
        color: #b00020;
    }
</style>
</head>
<body>

<h1>Ethan Towers — CV</h1>

<div id="pdf-viewer">
    <div id="loading">Loading preview…</div>
</div>

<div id="download-link">
    <a id="download-anchor" href="Ethan-Towers-CV.pdf" download>Download CV (PDF)</a>
</div>

<script>

const PDFJS_VERSION = "4.2.67";
const cdnWorkerUrls = [
  `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${PDFJS_VERSION}/pdf.worker.min.js`,
  `https://unpkg.com/pdfjs-dist@${PDFJS_VERSION}/build/pdf.worker.min.js`
];

async function ensureWorker() {
  if (!window.pdfjsLib) {
    await new Promise(res => setTimeout(res, 50));
  }

  if (!window.pdfjsLib) {
    console.error("pdfjsLib is not available (pdf.min.js didn't load).");
    return false;
  }

  for (const workerUrl of cdnWorkerUrls) {
    try {
      const resp = await fetch(workerUrl, { mode: "cors" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);

      const ct = resp.headers.get("content-type") || "";
      if (!/javascript|application\/x-javascript|text\/javascript/.test(ct)) {
        console.warn("Unexpected content-type for worker:", ct, " — trying fallback options.");
      }

      const blob = await resp.blob();
      const blobUrl = URL.createObjectURL(blob);
      pdfjsLib.GlobalWorkerOptions.workerSrc = blobUrl;
      console.info("pdf.worker loaded via blob URL (fetched from):", workerUrl);
      return true;
    } catch (err) {
      console.warn("Failed to fetch worker from", workerUrl, err);
    }
  }


  for (const workerUrl of cdnWorkerUrls) {
    try {
      pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
      console.info("Using CDN worker URL as fallback:", workerUrl);
      return true;
    } catch (err) {
      console.warn("Failed to set CDN worker URL as fallback:", workerUrl, err);
    }
  }

  const localWorker = "pdf.worker.min.js";
  pdfjsLib.GlobalWorkerOptions.workerSrc = localWorker;
  console.warn("Falling back to local worker path:", localWorker, " — ensure that file exists in the site root.");
  return true;
}

const url = "Ethan-Towers-CV.pdf";

async function renderPDF() {
  const viewer = document.getElementById("pdf-viewer");
  const loadingEl = document.getElementById("loading");
  loadingEl && (loadingEl.textContent = "Loading preview…");

  if (!window.pdfjsLib) {
    viewer.innerHTML = '<div id="error">PDF.js failed to load. Check the console for details.</div>';
    return;
  }

  await ensureWorker();

  try {
    const loadingTask = pdfjsLib.getDocument(url);
    const pdf = await loadingTask.promise;

    viewer.innerHTML = "";

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const pageWrapper = document.createElement("div");
      pageWrapper.style.marginBottom = "20px";

      const containerWidth = Math.min(viewer.clientWidth, 900) - 40;
      const unscaledViewport = page.getViewport({ scale: 1 });
      const desiredScale = Math.max(0.5, containerWidth / unscaledViewport.width);

      const viewport = page.getViewport({ scale: desiredScale });
      const outputScale = window.devicePixelRatio || 1;

      const canvas = document.createElement("canvas");
      const context = canvas.getContext("2d");

      canvas.style.width = Math.floor(viewport.width) + "px";
      canvas.style.height = Math.floor(viewport.height) + "px";

      canvas.width = Math.floor(viewport.width * outputScale);
      canvas.height = Math.floor(viewport.height * outputScale);
      context.setTransform(outputScale, 0, 0, outputScale, 0, 0);

      await page.render({ canvasContext: context, viewport }).promise;

      pageWrapper.appendChild(canvas);
      viewer.appendChild(pageWrapper);
    }
  } catch (err) {
    console.error("Error rendering PDF:", err);
    viewer.innerHTML = "<div id='error'>Failed to load PDF preview. You can still download the file below.</div>";
  }
}

renderPDF();
</script>

</body>
</html>
